{% extends "base.html" %}

{% block content %}
<h1>Quantum Minesweeper</h1>

<!-- Board -->
<table class="board">
  {% for r in range(rows) %}
  <tr>
    {% for c in range(cols) %}
    <td>
      {% if status == "ONGOING" %}
      <button type="button"
              onclick="clickCell({{r}},{{c}})"
              style="{{ grid[r][c]['style'] }}">
        {{ grid[r][c]['text']|safe }}
      </button>
      {% else %}
      <button disabled style="{{ grid[r][c]['style'] }}">
        {{ grid[r][c]['text']|safe }}
      </button>
      {% endif %}
    </td>
    {% endfor %}
  </tr>
  {% endfor %}
</table>

<!-- Status  -->
<h2>Status: {{ status }}</h2>

<!-- Tools -->
{% if status == "ONGOING" %}
<h3>Select Move</h3>
<div class="tools">
  <div class="tool-row">
    <button type="button" class="tool-btn" onclick="setTool('M')">M</button>
    <button type="button" class="tool-btn" onclick="setTool('P')">P</button>
  </div>
  {% if moveset in ["ONE_QUBIT", "ONE_QUBIT_COMPLETE", "TWO_QUBIT"] %}
  <div class="tool-row">
    {% for t in ["X","Y","Z","H","S"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
  {% if moveset in ["ONE_QUBIT_COMPLETE", "TWO_QUBIT"] %}
  <div class="tool-row">
    {% for t in ["SDG","SX","SXDG","SY","SYDG"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
  {% if moveset == "TWO_QUBIT" %}
  <div class="tool-row">
    {% for t in ["CX","CY","CZ","SWAP"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Hidden form used for all moves -->
<form id="move-form" action="/move?suid={{ suid }}" method="post" style="display:none">
  <input type="hidden" name="suid" value="{{ suid }}">
  <input type="hidden" id="cmd-input" name="cmd" value="">
</form>

<!-- Actions -->
{% if status == "ONGOING" %}
<h3>Actions</h3>
<form action="/game?suid={{ suid }}" method="post">
  <input type="hidden" name="suid" value="{{ suid }}">
  <button type="submit" name="action" value="reset">Reset Board</button>
  <button type="submit" name="action" value="new_same">New Board (same rules)</button>
  <button type="submit" name="action" value="new_rules">New Setup</button>
  <button type="button" id="toggle-theme">Toggle Theme</button>
</form>
{% else %}
<div class="gameover-overlay">
  <div class="gameover-box">
    <h2>Game Over!</h2>
    {% if result_msg %}
      <p>{{ result_msg }}</p>
    {% endif %}
    <div class="actions">
      <form action="/game?suid={{ suid }}" method="post">
        <input type="hidden" name="suid" value="{{ suid }}">
        <button type="submit" name="action" value="reset">Reset Board</button>
        <button type="submit" name="action" value="new_same">New Board</button>
        <button type="submit" name="action" value="new_rules">New Setup</button>
      </form>
    </div>
  </div>
</div>
{% endif %}


<script>
  const singleQ = new Set(['X','Y','Z','H','S','SDG','SX','SXDG','SY','SYDG']);
  const twoQ    = new Set(['CX','CY','CZ','SWAP']);
  let currentTool = localStorage.getItem("qms_tool") || "M";
  let firstPick = null;

  function setTool(t) {
    currentTool = t;
    localStorage.setItem("qms_tool", t);
    firstPick = null; // reset any 2-qubit selection
    // highlight
    document.querySelectorAll('.tool-btn').forEach(b => {
      b.classList.toggle('active', b.textContent === t);
    });
    document.querySelectorAll('.board button').forEach(b => b.classList.remove('pick'));
  }

  function sendCmd(cmd) {
    document.getElementById("cmd-input").value = cmd;
    document.getElementById("move-form").submit();
  }

  function clickCell(r, c) {
    const rc = `${r+1},${c+1}`;
    if (currentTool === 'M') { sendCmd(rc); return; }
    if (currentTool === 'P') { sendCmd(`P ${rc}`); return; }
    if (singleQ.has(currentTool)) { sendCmd(`${currentTool} ${rc}`); return; }
    if (twoQ.has(currentTool)) {
      if (!firstPick) {
        firstPick = [r,c];
        // highlight the first pick
        const row = document.querySelectorAll('.board tr')[r];
        const btn = row.querySelectorAll('button')[c];
        btn.classList.add('pick');
        return;
      } else {
        const [r1,c1] = firstPick;
        firstPick = null;
        // clear highlight from all buttons
        document.querySelectorAll('.board button').forEach(b => b.classList.remove('pick'));
        const rc1 = `${r1+1},${c1+1}`;
        sendCmd(`${currentTool} ${rc1} ${rc}`);
      }
    }
  }
  
  // restore last selected tool on load
  document.addEventListener("DOMContentLoaded", () => {
    setTool(currentTool);
  });
</script>
{% endblock %}
