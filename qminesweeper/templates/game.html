{% extends "base.html" %}
{% block body_class %}game-page{% endblock %}
{% block main_class %}game-page{% endblock %}
{% block title %}Quantum Minesweeper{% endblock %}

{% set allow_reset = (FEATURES.reset_policy == 'any') or 
                     (FEATURES.reset_policy == 'sandbox' and status == 'ONGOING' and moveset == 'SANDBOX') %}

{% block content %}
<!-- Status  -->
<table class="status-table">
  <tr>
    <!-- Left: expected mines -->
    <td class="mine-counter" help-id="mine-counter">
      âŸ¨MinesâŸ© = {{ "%.1f"|format(mines_exp) }}
    </td>

    <!-- Middle: empty for now -->
    <td class="status-spacer"></td>

    <!-- Right: entanglement -->
    <td class="entanglement" help-id="entanglement">
      Entanglement = {{ "%d"|format(ent_measure) }} bits
    </td>
  </tr>
</table>

<!-- Board -->
<div class="board-container">
  <table class="board">
    {% for r in range(rows) %}
    <tr>
      {% for c in range(cols) %}
        {% set val = grid[r][c] %}

        {% if val == -1 %}
          {% set symbol = "â– " %}
          {% set cls = "unexplored" %}
        {% elif val == -2 %}
          {% set symbol = "âš‘" %}
          {% set cls = "pinned" %}
        {% elif val == 9.0 %}
          {% set symbol = "ðŸ’¥" %}
          {% set cls = "mine" %}
        {% elif val == 0.0 %}
          {% set symbol = "&nbsp;" %}
          {% set cls = "empty" %}
        {% else %}
          {% set symbol = "%.1f"|format(val) %}
          {% set cls = "clue" %}
        {% endif %}

        <td>
          {% if status == "ONGOING" %}
            <button type="tool-btn"
                    onclick="clickCell({{ r }},{{ c }})"
                    class="tile {{ cls }}"
                    {% if cls == "clue" %} data-val="{{ val }}" {% endif %}>
              {{ symbol|safe }}
            </button>
          {% else %}
            <button disabled class="tile {{ cls }}"
                    {% if cls == "clue" %} data-val="{{ val }}" {% endif %}>
              {{ symbol|safe }}
            </button>
          {% endif %}
        </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </table>
</div>

<!-- Tools -->
{% if status == "ONGOING" %}
<h3>Select Move</h3>
<div class="tools">
  <div class="tool-row">
    <button type="button" class="tool-btn" onclick="setTool('M')" help-id="M-move">M</button>
    <button type="button" class="tool-btn" onclick="setTool('P')" help-id="P-move">P</button>
  </div>
  {% if moveset in ["ONE_QUBIT", "ONE_QUBIT_COMPLETE", "TWO_QUBIT", "TWO_QUBIT_EXTENDED"] %}
  <div class="tool-row">
    {% for t in ["X","Y","Z","H","S"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')" help-id="{{t}}-gate">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
  {% if moveset in ["ONE_QUBIT_COMPLETE", "TWO_QUBIT_EXTENDED"] %}
  <div class="tool-row">
    {% for t in ["SDG","SX","SXDG","SY","SYDG"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')" help-id="{{t}}-gate">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
  {% if moveset == "TWO_QUBIT" %}
  <div class="tool-row">
    {% for t in ["CX", "SWAP"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')" help-id="{{t}}-gate">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
  {% if moveset == "TWO_QUBIT_EXTENDED" %}
  <div class="tool-row">
    {% for t in ["CX","CY","CZ","SWAP"] %}
      <button type="button" class="tool-btn" onclick="setTool('{{t}}')" help-id="{{t}}-gate">{{t}}</button>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Hidden form used for all moves -->
<form id="move-form" action="/move?game_id={{ game_id }}" method="post" style="display:none">
  <input type="hidden" name="game_id" value="{{ game_id }}">
  <input type="hidden" id="cmd-input" name="cmd" value="">
</form>

<!-- Inline Help mount (mobile only) -->
<div id="help-mount"></div>

<!-- Actions -->
{% if status == "ONGOING" %}
<h3>Actions</h3>
<form action="/game?game_id={{ game_id }}" method="post">
  <input type="hidden" name="game_id" value="{{ game_id }}">
  {% if FEATURES.reset_policy == 'any' 
      or (FEATURES.reset_policy == 'sandbox' and moveset == 'SANDBOX') %}
  <button type="submit" class="btn" name="action" value="reset">Reset Board</button>
  {% endif %}
  <button type="submit" class="btn" name="action" value="new_same">New Game</button>
  <button type="submit" class="btn" name="action" value="new_rules">New Setup</button>
</form>

{% else %}
<div class="gameover-overlay">
  <div class="gameover-box">
    <h2>Game Over</h2>
    {% if status == "WIN" %}
      <div class="result-icon">ðŸŽ‰</div>
      <p class="result-msg win">You win!</p>
    {% elif status == "LOST" %}
      <div class="result-icon">ðŸ’¥</div>
      <p class="result-msg lost">You lost!</p>
    {% endif %}

    <div class="actions">
      <form action="/game?game_id={{ game_id }}" method="post">
        <input type="hidden" name="game_id" value="{{ game_id }}">
        {% if FEATURES.reset_policy == 'any' 
          or (FEATURES.reset_policy == 'sandbox' and moveset == 'SANDBOX') %}
        <button type="submit" class="btn" name="action" value="reset">Reset Board</button>
        {% endif %}
        <button type="submit" name="action" value="new_same" class="btn">New Game</button>
        <button type="submit" name="action" value="new_rules" class="btn">New Setup</button>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script src="/static/scripts/clue_style.js"></script>
<script src="/static/scripts/tools.js"></script>

{% endblock %}
